import{_ as h}from"./preload-helper.a4192956.js";import{ae as s}from"./scheduler.cc6cbc02.js";import{logout as l,isAuthenticated as p,user as y,authToken as v}from"./auth.9aaca404.js";import{g as c,P as u}from"./paths.f059e082.js";function f(){return s(p)}function d(){return s(y)}function O(e=u.LOGIN){return f()?!0:(c(e),!1)}function P(e=u.HOME){const r=d();return!f()||!(r!=null&&r.is_admin)?(c(e),!1):!0}function w(e){const r=d();return r&&(r.username===e||r.id===e||r.is_admin)}function D(e=u.HOME){return f()?(c(e),!0):!1}function N(e,r="md"){if(e!=null&&e.avatar_url)return e.avatar_url;const t=(e==null?void 0:e.email)||"default@example.com";return`https://www.gravatar.com/avatar/${btoa(t.toLowerCase())}?s=${{sm:32,md:64,lg:128,xl:256}[r]}&d=identicon`}function U(e){return(e==null?void 0:e.full_name)||(e==null?void 0:e.username)||"Anonymous User"}function L(e,r=null){var n;const t=d();if(!t)return!1;if(t.is_admin)return!0;switch(e){case"read":return!0;case"write":case"delete":return r?w(r.owner_id||((n=r.owner)==null?void 0:n.id)):!1;case"admin":return t.is_admin;default:return!1}}function g(e){try{if(!e)return null;const r=e.split(".");return r.length!==3?null:JSON.parse(atob(r[1]))}catch(r){return console.error("Failed to parse JWT token:",r),null}}function x(e){const r=g(e);if(!r||!r.exp)return!0;const t=r.exp*1e3;return Date.now()>=t}function k(e){const r=g(e);if(!r||!r.exp)return 0;const t=r.exp*1e3,n=Date.now(),a=t-n;return Math.max(0,a)}function I(e,r=30){const t=k(e),n=r*60*1e3;return t<=n&&t>0}function m(){const e=s(v)||localStorage.getItem("authToken"),r=s(p);if(!e||!r)return{valid:!1,expired:!0,needsRefresh:!1};const t=x(e),n=I(e);return{valid:!t,expired:t,needsRefresh:n,remainingTime:k(e)}}let i=null,o=null;async function T(){if(i)return i;const e=localStorage.getItem("refreshToken");if(!e)return console.warn("No refresh token found, user needs to login again"),l(),{success:!1,error:"No refresh token available"};i=R(e);try{return await i}finally{i=null}}async function R(e){try{const{api:r}=await h(()=>import("./api.ecdb55f2.js").then(n=>n.b),["./api.ecdb55f2.js","./preload-helper.a4192956.js","./paths.f059e082.js","./singletons.434e14c9.js","./scheduler.cc6cbc02.js"],import.meta.url),t=await r.refreshToken(e);if(t.success){localStorage.setItem("authToken",t.data.access_token),t.data.refresh_token&&localStorage.setItem("refreshToken",t.data.refresh_token);const{login:n}=await h(()=>import("./auth.9aaca404.js"),["./auth.9aaca404.js","./preload-helper.a4192956.js","./singletons.434e14c9.js","./scheduler.cc6cbc02.js"],import.meta.url),a=JSON.parse(localStorage.getItem("user")||"{}");return n(t.data.access_token,a),console.log("Token refreshed successfully"),{success:!0,data:t.data}}else return console.error("Token refresh failed:",t.error),l(),{success:!1,error:t.error}}catch(r){return console.error("Token refresh error:",r),l(),{success:!1,error:r.message}}}async function _(){const e=m();return e.expired?(console.log("Token已过期，尝试刷新..."),await T()):e.needsRefresh?(console.log("Token即将过期，提前刷新..."),await T()):{success:!0,message:"Token still valid"}}function H(){o&&clearInterval(o),o=setInterval(async()=>{const e=m();e.needsRefresh&&!i?(console.log("定期检查：Token即将过期，开始刷新..."),await _()):e.expired&&(console.log("定期检查：Token已过期，停止定时器"),clearInterval(o),o=null)},5*60*1e3),console.log("Token refresh timer started")}function J(){o&&(clearInterval(o),o=null,console.log("Token refresh timer cleared"))}function M(){typeof document>"u"||document.addEventListener("visibilitychange",async()=>{if(document.visibilityState==="visible"){const e=m();(e.expired||e.needsRefresh)&&(console.log("页面恢复可见，检查token状态..."),await _())}})}export{_ as autoRefreshToken,f as checkAuth,m as checkTokenValidity,J as clearTokenRefreshTimer,d as getCurrentUser,k as getTokenRemainingTime,N as getUserAvatarUrl,U as getUserDisplayName,L as hasPermission,w as isOwner,x as isTokenExpired,I as isTokenExpiringSoon,g as parseJwtToken,D as redirectIfAuthenticated,T as refreshTokenSilently,P as requireAdmin,O as requireAuth,H as setupTokenRefreshTimer,M as setupVisibilityChangeHandler};
